# OSCAR Datagen Toolkit

This repository contains a set of tools for generating synthetic datasets using the CARLA Simulator. [CARLA](https://carla.org/) is an open-source simulator for autonomous driving research that provides realistic urban environments, dynamic traffic, and realistic sensors.

## Requirements

- [Docker](./docs/Setup-Docker.md)

If you want to install the tools outside of the Docker container, build and install the CARLA Python package before install the tools:

```
cd docker

# build the CARLA client
# NOTE: Specify the Python3 version you want to use
./build --python-version=3.9

# install CARLA
pip install build/carla/PythonAPI/carla/dist/carla-0.9.13-cp39-cp39-linux_x86_64.whl
```

> **Note**: It is recommended to create a Python virtual environment.
>
> ```
> # [OPTIONAL] create conda environment
> conda create -n myenv python=3.9
> conda activate myenv
>
> # [OPTIONAL] create virtualenv environment
> python3.9 -m venv .venv
> source .venv/bin/activate
> ```

## Getting started

### Quickstart
```
# collect data
./scripts/collect.sh <CONFIG-FILE>

# annotate
./scripts/annotate.sh <FORMAT> --dataset_parent_dir="/opt/datagen-repo/data/"
```

For more information about the command options see [Tools](#tools) section.

### Install with Docker:

1. Clone this repository to your local machine.
2. Build the required Docker images:

```
# Build oscar/base image
docker compose build base

# Build oscar/datagen image
docker compose build annotator

# Build CARLA image
docker compose build carla
```

> **Note**: The `collect.sh` and `annotate.sh` scripts automatically verify the exitances of these Docker images and build them if necessary. You can use the above command if you want to rebuild the Docker images.

### Install from source code

1. Run the following command:

```
pip install .
```

> **Note**: In this case, make sure that you have a running CARLA server to connect with.

> \[Optional\] Install the pre-commit hook to verify code style:

```
pip install pre-commit==2.20.0

# To run the hook on every commit
pre-commit install

# To run it manually
pre-commit run -a
```

## Tools

The following tools are included in this repository:

### oscar_data_saver.py

This script sets up a CARLA simulation under certain parameters specified in one of the YAML's configuration files located at **configs/simulation**, and then proceed with collection of the data from the sensors included in that simulation. To use this script run:

```
./scripts/collect.sh <CONFIG-FILE>
```

where `CONFIG-FILE` is replaced with the path of the simulation configuration file.

This script also provides the possibility to scale the data collection by using the `--scale` option:

```
./scripts/collect.sh --scale=<NUM> <CONFIG-FILE>
```

To run this tool outside the Docker container use the following command"

```
oscar_data_saver --config-dir=</path/to/config/directory> --config-name=<CONFIG_NAME> hydra.run.dir=</path/to/output>
```

> Find [here](./docs/Data-collector-config-example.md) an example configuration file.

> By default the generated data is stored in the `data` directory, and the logs in the `logs` directory. If you want to change those paths, modify the variables **HOST_DATA_MOUNT_POINT** and **HOST_LOG_MOUNT_POINT** defined in the [.env](./.env) file.

> The **PROJECT_ROOT** environment variable is used to define where the data and logs will be stored.

### oscar_data_annotator.py

This script takes the data previously generated by the **oscar_data_saver.py** tool and creates COCO- or MOTS-compatible datasets. The following is an example of how to use this tool:

```
./scripts/annotate.sh <FORMAT> --dataset_parent_dir="/opt/datagen-repo/data/"
```

where:

- FORMAT: type of annotation that is going to be generated (*kwcoco*, *mots_txt* or *motx_png*).

> **Note**: The data directory is mapped to `/opt/datagen-repo/data` inside the Docker container.

To run this tool outside the Docker container use the following command:

```
oscar_data_annotator <FORMAT> --dataset_parent_dir="/opt/datagen-repo/data/"
```

## Troubleshooting

If you get the following error:

```
[2023-06-29 16:52:03,384][oscar_datagen_tools.simulation.utils.utils][ERROR] - boost::filesystem::create_directories: Permission denied: "//carlaCache//0.9.13-dirty/Carla/Maps"
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/oscar_datagen_tools/simulation/utils/utils.py", line 55, in wrapper
    func(*args)
  File "/usr/local/lib/python3.8/dist-packages/oscar_datagen_tools/simulation/context.py", line 91, in setup_simulator
    self.world.set_pedestrians_seed(self.client_params.seed)
RuntimeError: boost::filesystem::create_directories: Permission denied: "//carlaCache//0.9.13-dirty/Carla/Maps"
```

or

```
Traceback (most recent call last):
  File "/usr/lib/python3.8/pathlib.py", line 1288, in mkdir
    self._accessor.mkdir(self, mode)
PermissionError: [Errno 13] Permission denied: '/opt/datagen-repo/data/9ba7171f-5b97-4fe2-88cd-c0a8649fee29'
```

This may be due that your host system user does not have sudo privileges. A possible solutions is to set a root user to the annotator service in the `compose.yaml` file:

```diff
diff --git a/compose.yaml b/compose.yaml
index 33d8ade..9da2b36 100644
--- a/compose.yaml
+++ b/compose.yaml
@@ -16,7 +16,7 @@ services:
         CARLA_VERSION: ${CARLA_VERSION}
         OS_VER: ${DATAGEN_TOOLS_VERSION}
     image: oscar/datagen:${DATAGEN_TOOLS_VERSION}
-    user: ${U_ID}:${G_ID}
+    user: 0:0
     working_dir: ${HOME}
     entrypoint: oscar_data_annotator
     volumes:
```
