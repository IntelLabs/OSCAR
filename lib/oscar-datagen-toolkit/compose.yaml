name: "oscar${CUDA_VISIBLE_DEVICES}"
version: "3.9"
services:
  oscar_data_annotator:
    container_name: ${COMPOSE_PROJECT_NAME}-oscar_data_annotator
    env_file: .env
    build:
      context: .
      dockerfile: docker/Dockerfile-oscar-datagen
      args:
        CARLA_VERSION: ${CARLA_VERSION}
    image: oscar/datagen:${DATAGEN_TOOLS_VERSION}
    entrypoint: oscar_data_annotator
    volumes:
      - .:/workspace

  oscar_data_saver:
    container_name: ${COMPOSE_PROJECT_NAME}-oscar_data_saver
    extends: oscar_data_annotator
    entrypoint: oscar_data_saver context.client_params.host=carla
    volumes:
      - .:/workspace
    depends_on:
      carla:
        condition: service_healthy

  carla:
    container_name: ${COMPOSE_PROJECT_NAME}-carla
    env_file: .env
    shm_size: 30GB
    build:
      context: .
      dockerfile: docker/Dockerfile-carla
      args:
        CARLA_VERSION: ${CARLA_VERSION}
    image: oscar/carla:${CARLA_VERSION}
    command: /bin/bash ./CarlaUE4.sh -RenderOffScreen -nosound -quality-level=epic
    restart: no
    healthcheck:
      test: ["CMD-SHELL", "python3.7 -c \"import sys; sys.path.append('/home/carla/PythonAPI/carla/dist/carla-0.9.13-py3.7-linux-x86_64.egg'); import carla; c = carla.Client('carla', 2000); print(c.get_server_version())\""]
      start_period: 30s
      start_interval: 5s
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              device_ids: ["${CUDA_VISIBLE_DEVICES:-all}"] # FIXME: Use - instead of :-?

  adversary:
    container_name: ${COMPOSE_PROJECT_NAME}-adversary
    # stdin_open: true # docker run -i
    # tty: true        # docker run -t
    # entrypoint: bash
    entrypoint: python${PYTHON_VERSION} -m mart
    env_file: .env
    shm_size: 30GB
    build:
      context: .
      dockerfile: docker/Dockerfile-adversary
      args:
        DATAGEN_TOOLS_VERSION: ${DATAGEN_TOOLS_VERSION}
        PYTHON_VERSION: ${PYTHON_VERSION}
    image: oscar/adversary:${DATAGEN_TOOLS_VERSION}
    restart: no
    volumes:
      - .:/workspace
    depends_on:
      carla:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              device_ids: ["${CUDA_VISIBLE_DEVICES:-all}"] # FIXME: Use - instead of :-?
